services:
  nginx:
    image: nginx:1.25-alpine
    container_name: front_nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # nginx 主配置（你后面几乎不用改）
      - ./data/nginx/nginx.conf:/etc/nginx/nginx.conf:ro

      # 由 controller 生成的站点配置
      - ./data/nginx/sites:/etc/nginx/conf.d:ro

      # nginx 日志（给你攻击检测 + logrotate 用）
      - ./data/nginx/logs:/var/log/nginx

      # certbot webroot（HTTP-01 challenge）
      - ./data/certbot/www:/var/www/certbot

      # 证书目录（live/archive/renewal）
      - ./data/certbot/conf:/etc/letsencrypt
    depends_on:
      - controller

  certbot:
    image: certbot/certbot:latest
    container_name: front_certbot
    volumes:
      - ./data/certbot/www:/var/www/certbot
      - ./data/certbot/conf:/etc/letsencrypt
    entrypoint: /bin/sh
    # 默认不做事，后续由 controller docker exec 调用
    command: -c "trap exit TERM; while :; do sleep 3600; done"

  controller:
    image: python:3.11-alpine
    container_name: front_controller
    restart: unless-stopped
    volumes:
      - ./app:/app/app:ro

      # controller 生成 nginx 配置的输出目录
      - ./data/nginx/sites:/app/nginx-sites

      # certbot 共享目录（给后面签证/续期用）
      - ./data/certbot/www:/var/www/certbot
      - ./data/certbot/conf:/etc/letsencrypt
    working_dir: /app
    command: ["python", "/app/app/controller.py"]

services:
  nginx:
    image: nginx:1.25-alpine
    container_name: front_nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # nginx 主配置（你后面几乎不用改）
      - ./data/nginx/nginx.conf:/etc/nginx/nginx.conf:ro

      # 由 controller 生成的站点配置
      - ./data/nginx/sites:/etc/nginx/conf.d:ro

      # nginx 日志（给你攻击检测 + logrotate 用）
      - ./data/nginx/logs:/var/log/nginx

      # certbot webroot（HTTP-01 challenge）
      - ./data/certbot/www:/var/www/certbot

      # 证书目录（live/archive/renewal）
      - ./data/certbot/conf:/etc/letsencrypt
    depends_on:
      - controller

  certbot:
    image: certbot/certbot:latest
    container_name: front_certbot
    volumes:
      - ./data/certbot/www:/var/www/certbot
      - ./data/certbot/conf:/etc/letsencrypt
    entrypoint: /bin/sh
    # 默认不做事，后续由 controller docker exec 调用
    command: -c "trap exit TERM; while :; do sleep 3600; done"

  controller:
    image: python:3.11-alpine
    container_name: front_controller
    restart: unless-stopped
    volumes:
      - ./app:/app/app:ro

      # controller 生成 nginx 配置的输出目录
      - ./data/nginx/sites:/app/nginx-sites

      # certbot 共享目录（给后面签证/续期用）
      - ./data/certbot/www:/var/www/certbot
      - ./data/certbot/conf:/etc/letsencrypt
    working_dir: /app
    command: ["python", "/app/app/controller.py"]

  logrotate:
    image: alpine:3.20
    container_name: front_logrotate
    restart: unless-stopped
    volumes:
      # 读取 nginx 日志目录（宿主机 data/nginx/logs）
      - ./data/nginx/logs:/data/nginx/logs

      # 读取 logrotate 配置目录（你会把 nginx.conf 放在这里）
      - ./data/nginx/logrotate:/etc/logrotate.d
    command: >
      sh -c "
        apk add --no-cache logrotate &&
        echo '0 * * * * logrotate -v /etc/logrotate.d/nginx.conf' > /etc/crontabs/root &&
        crond -f -l 8
      "

  renewer:
    image: docker:cli
    container_name: front_renewer
    restart: unless-stopped
    volumes:
      # 允许在容器内调用 docker exec 到 front_certbot / front_nginx
      - /var/run/docker.sock:/var/run/docker.sock
    command: >
      sh -c "
        echo '[renewer] starting...';
        while :; do
          echo '[renewer] running certbot renew...';
          # 只会续期接近到期的证书，不会每次都重新申请
          docker exec front_certbot certbot renew --webroot -w /var/www/certbot || true;
          echo '[renewer] reloading nginx...';
          docker exec front_nginx nginx -t && docker exec front_nginx nginx -s reload || true;
          echo '[renewer] sleep 12h';
          sleep 43200;
        done
      "
